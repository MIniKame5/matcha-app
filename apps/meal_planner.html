<!--
    AIçŒ®ç«‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (Meal Planner) - å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆ
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«å¾“ã„ã€UIç·¨é›†ã®ã—ã‚„ã™ã•ã‚’è€ƒæ…®ã—ã¦HTMLãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«çµ±ä¸€ã€‚
    å…¨ã¦ã®CSS (Tailwind)ã€HTMLã€ãã—ã¦JavaScriptãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã‚ã‚‹ã€‚
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIçŒ®ç«‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ ğŸ½ï¸</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã‚€ãï¼ã“ã‚Œã§ã‹ã£ã“ã„ã„UIã‚’ä½œã‚‹ï¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slide-up {
            from { opacity: 0; transform: translate(-50%, 10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }
        /* ãƒˆãƒ¼ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #matcha-toast-meal-planner {
            transition: opacity 0.3s ease-in-out;
            bottom: 2rem;
        }
    </style>
    <script>
        // Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãï¼
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ (UIã¯ã“ã®ä¸‹ã«å…¨éƒ¨ã‚ã‚‹ãï¼) -->
    <div id="meal-planner-app" class="p-4 sm:p-8 space-y-8 max-w-4xl mx-auto">

        <!-- 1. çŒ®ç«‹ææ¡ˆãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="bg-white p-6 rounded-xl shadow-2xl border border-green-100">
            <h2 class="text-3xl font-extrabold text-green-700 mb-4">AIçŒ®ç«‹ææ¡ˆãƒ•ã‚©ãƒ¼ãƒ </h2>
            <p class="text-gray-600 mb-6">å†·è”µåº«ã®ä¸­èº«ã‚„æ°—åˆ†ã‚’å…¥åŠ›ã—ã¦ã­ï¼GeminiãŒã´ã£ãŸã‚Šã®çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹ãï¼</p>
            
            <form id="meal-form" class="space-y-4">
                <div>
                    <label for="ingredients" class="block text-sm font-bold text-gray-700 mb-1">1. å†·è”µåº«ã«ã‚ã‚‹ã‚‚ã®ï¼ˆå¿…é ˆï¼‰</label>
                    <textarea id="ingredients" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 transition-all shadow-sm" placeholder="ä¾‹: é¶ã‚€ã­è‚‰ã€ç‰ã­ãã€ãƒˆãƒãƒˆã€åµã€ãƒã‚®"></textarea>
                </div>

                <div>
                    <label for="mood" class="block text-sm font-bold text-gray-700 mb-1">2. é£Ÿã¹ãŸã„æ°—åˆ†ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="mood" class="w-full p-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 transition-all shadow-sm" placeholder="ä¾‹: ç–²ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã‚ã£ã•ã‚Šã—ãŸã‚‚ã®ã€ã‚¬ãƒƒãƒ„ãƒªä¸­è¯ã€ãƒ€ã‚¤ã‚¨ãƒƒãƒˆå‘ã">
                </div>

                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label for="people" class="block text-sm font-bold text-gray-700 mb-1">3. äººæ•°</label>
                        <input type="number" id="people" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 transition-all shadow-sm" required>
                    </div>
                    <div class="flex-1">
                        <label for="budget" class="block text-sm font-bold text-gray-700 mb-1">4. äºˆç®— (å††)</label>
                        <input type="number" id="budget" class="w-full p-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 transition-all shadow-sm" placeholder="ä¾‹: 1000 (ä»»æ„)">
                    </div>
                </div>

                <button type="submit" id="generate-button" class="w-full py-3 bg-green-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-green-700 transition-all active:scale-95 disabled:bg-gray-400">
                    ğŸ± çŒ®ç«‹ã‚’AIã«ææ¡ˆã—ã¦ã‚‚ã‚‰ã†ï¼
                </button>
            </form>
        </div>

        <!-- 2. çŒ®ç«‹ææ¡ˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="result-area" class="hidden">
            <div id="loading-spinner" class="text-center p-10 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-green-500 mx-auto mb-3"></div>
                <p class="text-green-600 font-semibold">GeminiãŒæœ€é«˜ã®çŒ®ç«‹ã‚’è€ƒãˆã¦ã‚‹ã...ã—ã°ã‚‰ãå¾…ã£ã¦ã­ï¼</p>
            </div>
            
            <div id="meal-proposal-card" class="bg-white p-6 rounded-xl shadow-2xl border border-green-100 hidden">
                <h2 class="text-2xl font-extrabold text-gray-800 border-b pb-3 mb-4 flex items-center">
                    <span class="text-3xl mr-2">ğŸ’¡</span>AIææ¡ˆã®çŒ®ç«‹
                </h2>
                <div id="proposal-content" class="text-gray-700 space-y-4">
                    <!-- ææ¡ˆå†…å®¹ãŒã“ã“ã«å…¥ã‚‹ -->
                </div>
            </div>
        </div>

        <!-- 3. è²·ã„ç‰©ãƒªã‚¹ãƒˆå±¥æ­´ -->
        <div id="history-area" class="bg-white p-6 rounded-xl shadow-2xl border border-green-100">
            <h2 class="text-2xl font-extrabold text-gray-800 border-b pb-3 mb-4 flex items-center">
                <span class="text-3xl mr-2">ğŸ›’</span>ä¿å­˜æ¸ˆã¿è²·ã„ç‰©ãƒªã‚¹ãƒˆ
            </h2>
            <div id="shopping-list-history" class="space-y-3">
                <p id="history-loading" class="text-center text-gray-500">ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                <!-- è²·ã„ç‰©ãƒªã‚¹ãƒˆã®å±¥æ­´ãŒã“ã“ã«å…¥ã‚‹ -->
            </div>
        </div>
        
        <p class="text-xs text-center text-gray-400">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="display-user-id">æœªèªè¨¼</span></p>

    </div>

    <!-- 4. JavaScriptãƒ­ã‚¸ãƒƒã‚¯ (å…¨ã¦ã“ã“ã«å…¥ã‚Œã‚‹ãï¼) -->
    <script type="module">
        // --- Firebase imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸåŒ–è¨­å®š ---
        let db;
        let auth;
        let userId = 'initializing...';
        
        // è²·ã„ç‰©ãƒªã‚¹ãƒˆã®Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’æ§‹ç¯‰ã™ã‚‹ãœï¼
        const getShoppingListCollectionPath = (uid) => {
            // __app_id ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§æä¾›ã•ã‚Œã‚‹ãŒã€ã“ã“ã§ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ã†ãï¼
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-meal-planner';
            return `artifacts/${appId}/users/${uid}/shopping_lists`;
        };
        
        // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ---
        const initApp = async () => {
            document.getElementById('display-user-id').textContent = 'èªè¨¼ä¸­...';
            
            // 1. Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼å‡¦ç†
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¨­å®š
                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('display-user-id').textContent = userId;

            } catch (error) {
                console.error("ğŸš¨ Firebaseã®åˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã«å¤±æ•—ï¼", error);
                userId = crypto.randomUUID();
                document.getElementById('display-user-id').textContent = `${userId} (èªè¨¼å¤±æ•—)`;
                showToast('ğŸš¨ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½ãŒä½¿ãˆãªã„ãï¼èªè¨¼å¤±æ•—ï¼', true);
            }

            // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('meal-form').addEventListener('submit', handleFormSubmit);

            // 3. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆè²·ã„ç‰©ãƒªã‚¹ãƒˆï¼‰
            loadShoppingLists();
        };


        // --- Gemini APIé€£æºãƒ­ã‚¸ãƒƒã‚¯ ---

        const handleFormSubmit = async (event) => {
            event.preventDefault();

            const form = document.getElementById('meal-form');
            const ingredients = form.elements.ingredients.value.trim();
            const mood = form.elements.mood.value.trim();
            const people = form.elements.people.value;
            const budget = form.elements.budget.value.trim();

            if (!ingredients) {
                showToast('ğŸš¨ å†·è”µåº«ã«ã‚ã‚‹ã‚‚ã®ã¯å¿…é ˆé …ç›®ã ãï¼', true);
                return;
            }
            
            // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«åˆ‡ã‚Šæ›¿ãˆ
            const generateButton = document.getElementById('generate-button');
            generateButton.disabled = true;
            generateButton.textContent = 'ææ¡ˆã‚’ç”Ÿæˆä¸­...';
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('meal-proposal-card').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');

            try {
                const proposal = await generateMealProposal(ingredients, mood, people, budget);
                renderProposal(proposal);
            } catch (error) {
                console.error("ğŸš¨ APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:", error);
                renderError(`ã”ã‚ã‚“ï¼AIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ãŸãã€‚ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                // UIã‚’å…ƒã«æˆ»ã™
                generateButton.disabled = false;
                generateButton.textContent = 'ğŸ± çŒ®ç«‹ã‚’AIã«ææ¡ˆã—ã¦ã‚‚ã‚‰ã†ï¼';
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        };

        const generateMealProposal = async (ingredients, mood, people, budget) => {
            const systemPrompt = `
                ã‚ãªãŸã¯ãƒ—ãƒ­ã®æ–™ç†å®¶ã§ã‚ã‚Šã€æ „é¤Šå£«ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã«åŸºã¥ãã€ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å³å¯†ã«å¾“ã£ã¦ã€çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

                ### ææ¡ˆã®ãƒ«ãƒ¼ãƒ«
                1. ææ¡ˆã¯å¿…ãšä¸»èœã¨å‰¯èœï¼ˆæœ€ä½1å“ï¼‰ã‚’å«ã‚€ã“ã¨ã€‚
                2. ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸã€Œå†·è”µåº«ã«ã‚ã‚‹ã‚‚ã®ã€ã‚’æœ€å¤§é™ã«æ´»ç”¨ã™ã‚‹ã“ã¨ã€‚
                3. ã€Œè²·ã„ç‰©ãƒªã‚¹ãƒˆã€ã¯ã€ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹ã‚’ä½œã‚‹ãŸã‚ã«ã€**ã€Œå†·è”µåº«ã«ã‚ã‚‹ã‚‚ã®ã€ä»¥å¤–**ã§è¿½åŠ è³¼å…¥ãŒå¿…è¦ãªã‚‚ã®ã ã‘ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨ã€‚
                4. å…¨ã¦ã®ææ¡ˆã¯æ—¥æœ¬èªã§ã€è¦ªã—ã¿ã‚„ã™ãã€ã‹ã¤ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒˆãƒ¼ãƒ³ã§è¡Œã†ã“ã¨ã€‚
                5. ææ¡ˆã®ã€Œèª¬æ˜ã€ã¯ã€çŒ®ç«‹ã®ãƒ†ãƒ¼ãƒã€æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã€ãªãœã“ã®çŒ®ç«‹ã‚’é¸ã‚“ã ã®ã‹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã€‚
            `;

            const userQuery = `
                ä»¥ä¸‹ã®æ¡ä»¶ã§çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„:
                - å†·è”µåº«ã«ã‚ã‚‹ã‚‚ã® (å¿…é ˆ): ${ingredients}
                - é£Ÿã¹ãŸã„æ°—åˆ†/ã‚¸ãƒ£ãƒ³ãƒ« (ä»»æ„): ${mood || 'æŒ‡å®šãªã—'}
                - äººæ•°: ${people}äººå‰
                - äºˆç®—ç›®å®‰ (ä»»æ„): ${budget ? budget + 'å††ä»¥å†…' : 'æŒ‡å®šãªã—'}
            `;
            
            // APIè¨­å®š
            const apiKey = "AIzaSyBzoqvWiQNrrIxLPRJ06XQ6B0ryBT-59Uc";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    proposal: {
                        type: "OBJECT",
                        properties: {
                            theme: { type: "STRING", description: "ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹ã«ä»˜ã‘ã‚‹é­…åŠ›çš„ãªã‚¿ã‚¤ãƒˆãƒ«" },
                            explanation: { type: "STRING", description: "çŒ®ç«‹ã®ãƒã‚¤ãƒ³ãƒˆã‚„æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã«é–¢ã™ã‚‹ç°¡å˜ãªèª¬æ˜ï¼ˆ3ã€œ4è¡Œï¼‰" },
                            totalCostEstimate: { type: "STRING", description: "ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹ã®åˆè¨ˆã‚³ã‚¹ãƒˆã®æ¦‚ç®—" },
                            menus: {
                                type: "ARRAY",
                                description: "ä¸»èœã¨å‰¯èœã®ãƒªã‚¹ãƒˆ",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING", description: "æ–™ç†å" },
                                        type: { type: "STRING", description: "ä¸»èœ or å‰¯èœ" },
                                        description: { type: "STRING", description: "ç°¡å˜ãªä½œã‚Šæ–¹ã®èª¬æ˜ã¾ãŸã¯ç‰¹å¾´" },
                                        requiredIngredients: {
                                            type: "ARRAY",
                                            description: "ã“ã®æ–™ç†ã«å¿…è¦ãªå…¨ã¦ã®ææ–™",
                                            items: { type: "STRING" }
                                        }
                                    },
                                    propertyOrdering: ["name", "type", "description", "requiredIngredients"]
                                }
                            },
                            shoppingList: {
                                type: "ARRAY",
                                description: "è¿½åŠ è³¼å…¥ãŒå¿…è¦ãªææ–™ã®ãƒªã‚¹ãƒˆã€‚",
                                items: { type: "STRING" }
                            }
                        },
                        propertyOrdering: ["theme", "explanation", "totalCostEstimate", "menus", "shoppingList"]
                    }
                }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            // APIã‚³ãƒ¼ãƒ«ã¨Exponential Backoffã®å®Ÿè£…
            const MAX_RETRIES = 5;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!jsonText) {
                        throw new Error("JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã ã‚ˆï¼");
                    }
                    
                    const parsedData = JSON.parse(jsonText);
                    if (parsedData.proposal && parsedData.proposal.menus) {
                        return parsedData.proposal;
                    } else {
                        throw new Error("JSONã®æ§‹é€ ãŒãŠã‹ã—ã„ãï¼");
                    }

                } catch (error) {
                    console.warn(`âš ï¸ ãƒªãƒˆãƒ©ã‚¤ä¸­ (${i + 1}/${MAX_RETRIES}):`, error.message);
                    if (i === MAX_RETRIES - 1) throw error;
                    
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        // --- çµæœè¡¨ç¤ºã¨è²·ã„ç‰©ãƒªã‚¹ãƒˆæ©Ÿèƒ½ ---

        const renderProposal = (proposal) => {
            const contentDiv = document.getElementById('proposal-content');
            const card = document.getElementById('meal-proposal-card');
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã®HTMLã‚’ç”Ÿæˆ
            const menusHTML = proposal.menus.map(menu => `
                <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500 shadow-sm">
                    <h4 class="text-lg font-bold text-gray-800">${menu.name} <span class="text-sm font-normal text-green-600">(${menu.type})</span></h4>
                    <p class="text-sm text-gray-600 mt-1">${menu.description}</p>
                    <div class="mt-2 text-xs text-gray-500">
                        <span class="font-semibold">ä½¿ç”¨ææ–™:</span> ${menu.requiredIngredients.join(', ')}
                    </div>
                </div>
            `).join('');
            
            // è²·ã„ç‰©ãƒªã‚¹ãƒˆã®HTMLã‚’ç”Ÿæˆ
            let shoppingListHTML;
            if (proposal.shoppingList && proposal.shoppingList.length > 0) {
                const listItems = proposal.shoppingList.map(item => `
                    <li class="flex items-center space-x-2 text-sm text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                        <span>${item}</span>
                    </li>
                `).join('');
                
                // Firestoreä¿å­˜ã®ãŸã‚ã®é–¢æ•°å‘¼ã³å‡ºã—ï¼ˆJSON.stringifyã‚’ä½¿ã£ã¦æ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãï¼ï¼‰
                const jsonItems = JSON.stringify(proposal.shoppingList).replace(/"/g, '&quot;');

                shoppingListHTML = `
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="text-lg font-bold text-yellow-800 mb-2 flex items-center">ğŸ›’ å¿…è¦ãªè²·ã„ç‰©ãƒªã‚¹ãƒˆ</h4>
                        <ul class="list-none space-y-1 pl-0">
                            ${listItems}
                        </ul>
                        <button onclick="saveShoppingList('${proposal.theme}', '${jsonItems}')"
                                class="mt-4 w-full py-2 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition-colors active:scale-95 shadow-md">
                            ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹ï¼
                        </button>
                    </div>
                `;
            } else {
                shoppingListHTML = `
                    <div class="p-4 bg-blue-50 text-blue-800 rounded-lg border border-blue-200 font-semibold text-center">
                        ğŸ‘ ç´ æ™´ã‚‰ã—ã„ï¼å†·è”µåº«ã®é£Ÿæã ã‘ã§è³„ãˆã‚‹ã‚ˆï¼
                    </div>
                `;
            }

            // å…¨ä½“ã®HTMLã‚’çµ„ã¿ç«‹ã¦ã¦è¡¨ç¤º
            contentDiv.innerHTML = `
                <h3 class="text-3xl font-extrabold text-green-700">${proposal.theme}</h3>
                <p class="text-sm italic text-gray-500 mb-4 border-b pb-4">äºˆç®—æ¦‚ç®—: ${proposal.totalCostEstimate}</p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-gray-700">ãƒã‚¤ãƒ³ãƒˆ:</h4>
                    <p class="text-sm text-gray-600 whitespace-pre-wrap">${proposal.explanation}</p>
                </div>

                <h4 class="text-xl font-bold text-gray-800 border-b border-dashed pb-2 mb-3">ğŸ½ï¸ çŒ®ç«‹</h4>
                <div class="space-y-3">
                    ${menusHTML}
                </div>
                
                <h4 class="text-xl font-bold text-gray-800 border-b border-dashed pb-2 mb-3 mt-6">ğŸ›ï¸ è²·ã„ç‰©</h4>
                ${shoppingListHTML}
            `;

            card.classList.remove('hidden');
        };

        const renderError = (message) => {
            const card = document.getElementById('meal-proposal-card');
            card.classList.remove('hidden');
            card.innerHTML = `
                <div class="text-center p-8 bg-red-50 rounded-xl border border-red-200">
                    <span class="text-4xl block mb-3">âŒ</span>
                    <h3 class="text-xl font-bold text-red-600 mb-2">çŒ®ç«‹ææ¡ˆã«å¤±æ•—ï¼</h3>
                    <p class="text-red-500 text-sm">${message}</p>
                </div>
            `;
        };

        /**
         * è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’Firestoreã«ä¿å­˜ã™ã‚‹ãï¼ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¦HTMLã‹ã‚‰å‘¼ã³å‡ºã™ï¼‰
         */
        window.saveShoppingList = async (theme, jsonItemsString) => {
            if (!db || !userId || userId === 'initializing...') {
                showToast('ğŸš¨ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ï¼èªè¨¼ã‚’å¾…ã£ã¦å†è©¦è¡Œã—ã¦ã­ã€‚', true);
                return;
            }
            
            let items;
            try {
                items = JSON.parse(jsonItemsString);
            } catch (e) {
                console.error("ğŸš¨ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼", e);
                showToast('ğŸš¨ ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒãŠã‹ã—ã„ãï¼', true);
                return;
            }


            const saveButton = event.currentTarget;
            const originalText = saveButton.textContent;
            saveButton.textContent = 'ä¿å­˜ä¸­...';
            saveButton.disabled = true;

            try {
                const listData = {
                    theme: theme,
                    items: items,
                    createdAt: new Date(),
                };

                const colRef = collection(db, getShoppingListCollectionPath(userId));
                await addDoc(colRef, listData);

                showToast('âœ… è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã—ãŸã‚ˆï¼å±¥æ­´ã‚’ç¢ºèªã—ã¦ã­ï¼');
                loadShoppingLists();
                
            } catch (e) {
                console.error("ğŸš¨ Firestoreã¸ã®ä¿å­˜ã«å¤±æ•—ï¼", e);
                showToast(`ğŸš¨ ãƒªã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`, true);
            } finally {
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }
        };

        /**
         * Firestoreã‹ã‚‰è²·ã„ç‰©ãƒªã‚¹ãƒˆã®å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€ãï¼
         */
        const loadShoppingLists = async () => {
            const historyDiv = document.getElementById('shopping-list-history');
            const loadingMessage = document.getElementById('history-loading');
            
            if (!db || !userId || userId === 'initializing...') {
                historyDiv.innerHTML = '<p class="text-red-500 text-sm">èªè¨¼ä¸­/æœªèªè¨¼ã®ãŸã‚å±¥æ­´ã‚’èª­ã¿è¾¼ã‚ãªã„ãï¼</p>';
                return;
            }
            
            loadingMessage.classList.remove('hidden');

            try {
                const colRef = collection(db, getShoppingListCollectionPath(userId));
                // ã‚½ãƒ¼ãƒˆã¯ in-memory ã§è¡Œã†ãŸã‚ã€ã‚¯ã‚¨ãƒªã§ã¯æŒ‡å®šã—ãªã„
                const querySnapshot = await getDocs(query(colRef));

                const lists = [];
                querySnapshot.forEach((doc) => {
                    lists.push({ id: doc.id, ...doc.data() });
                });
                
                // æ—¥ä»˜ã§é™é †ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šï¼‰
                lists.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                renderShoppingListHistory(lists);

            } catch (e) {
                console.error("ğŸš¨ Firestoreã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼", e);
                historyDiv.innerHTML = `<p class="text-red-500 text-sm">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
            } finally {
                loadingMessage.classList.add('hidden');
            }
        };

        /**
         * è²·ã„ç‰©ãƒªã‚¹ãƒˆã®å±¥æ­´ã‚’HTMLã§æç”»ã™ã‚‹ãï¼
         */
        const renderShoppingListHistory = (lists) => {
            const historyDiv = document.getElementById('shopping-list-history');

            if (lists.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-50 rounded-lg">ã¾ã ä¿å­˜ã•ã‚ŒãŸè²·ã„ç‰©ãƒªã‚¹ãƒˆã¯ãªã„ã‚ˆã€‚</p>';
                return;
            }

            const historyHTML = lists.map(list => {
                const date = list.createdAt?.toDate();
                const dateStr = date ?
                    date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) :
                    'æ—¥ä»˜ä¸æ˜';
                
                const itemsHTML = list.items.map(item => `
                    <span class="inline-block bg-gray-200 text-gray-700 text-xs font-semibold px-2 py-1 rounded-full mr-2 mb-1">${item}</span>
                `).join('');

                return `
                    <div id="list-${list.id}" class="p-4 bg-white rounded-xl shadow-md border border-gray-100 transition-shadow hover:shadow-lg">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800">${list.theme}</h4>
                            <button onclick="deleteShoppingList('${list.id}')"
                                    class="text-red-400 hover:text-red-600 transition-colors" title="ã“ã®ãƒªã‚¹ãƒˆã‚’å‰Šé™¤">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">ä¿å­˜æ—¥æ™‚: ${dateStr}</p>
                        <div class="flex flex-wrap">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            }).join('');

            historyDiv.innerHTML = historyHTML;
        };

        /**
         * è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’Firestoreã‹ã‚‰å‰Šé™¤ã™ã‚‹ãï¼ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¦HTMLã‹ã‚‰å‘¼ã³å‡ºã™ï¼‰
         */
        window.deleteShoppingList = (listId) => {
            if (!db || !userId || userId === 'initializing...') {
                showToast('ğŸš¨ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ï¼ã‚·ã‚¹ãƒ†ãƒ ãŒæœªèªè¨¼ã‹ã‚‚ã€‚', true);
                return;
            }

            // å‰Šé™¤ç¢ºèªã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
            const modalHTML = `
                <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[9000]">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center transform transition-all scale-100 animate-slide-up">
                        <span class="text-4xl block mb-4 text-red-500">ğŸ—‘ï¸</span>
                        <h3 class="text-xl font-bold mb-2 text-gray-800">ãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
                        <p class="text-sm text-gray-500 mb-6">ã“ã®è²·ã„ç‰©ãƒªã‚¹ãƒˆã¯å…ƒã«æˆ»ã›ãªã„ãï¼</p>
                        
                        <div class="flex justify-center space-x-4">
                            <button onclick="document.getElementById('delete-confirm-modal').remove()" 
                                    class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition-colors active:scale-95">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="performDeleteShoppingList('${listId}')" 
                                    class="px-5 py-2 bg-red-600 text-white font-semibold rounded-full hover:bg-red-700 transition-colors active:scale-95 shadow-md">
                                å‰Šé™¤ã™ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        };

        // å®Ÿéš›ã®å‰Šé™¤å‡¦ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¦HTMLã‹ã‚‰å‘¼ã³å‡ºã™ï¼‰
        window.performDeleteShoppingList = async (listId) => {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('delete-confirm-modal')?.remove();

            try {
                const docRef = doc(db, getShoppingListCollectionPath(userId), listId);
                await deleteDoc(docRef);
                showToast('ğŸ—‘ï¸ è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã—ãŸã‚ˆï¼');
                loadShoppingLists();

            } catch (e) {
                console.error("ğŸš¨ ãƒªã‚¹ãƒˆã®å‰Šé™¤ã«å¤±æ•—ï¼", e);
                showToast(`ğŸš¨ ãƒªã‚¹ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`, true);
            }
        };


        // --- æ±ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (Toast) ---

        const showToast = (message, isError = false) => {
            const container = document.body;
            let toast = document.getElementById('matcha-toast-meal-planner');

            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'matcha-toast-meal-planner';
                toast.className = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity duration-300 z-[9999] text-sm font-semibold';
                container.appendChild(toast);
            }

            toast.classList.remove('opacity-100', 'bg-green-600', 'bg-red-600');
            
            toast.textContent = message;
            toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600', 'text-white');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        };

        // DOMã®ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã™ã‚‹ãï¼
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>


