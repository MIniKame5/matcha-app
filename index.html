<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¾ã£ã¡ã‚ƒOS - AIæ‹¡å¼µæ©Ÿèƒ½</title>
    <!-- Tailwind CSSã®ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Markdownè¡¨ç¤ºç”¨ã®ç°¡æ˜“ã‚¹ã‚¿ã‚¤ãƒ« */
        .markdown-body h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-body h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-body ul { list-style: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 1rem; }
        .markdown-body li { margin-bottom: 0.25rem; }

        /* å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã®è„ˆå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - Puni Puni Style! */
        @keyframes pulse-shake {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.03) rotate(-1deg); }
        }
        .animate-pulse {
            animation: pulse-shake 1.5s infinite alternate;
        }
    </style>
</head>
<body>
    <div id="app-container" class="min-h-screen bg-gray-50 flex flex-col">
        <!-- Main views will be rendered here -->
    </div>

    <!-- Firebase SDK Imports (æ°¸ç¶šåŒ–ã¨èªè¨¼ã®ãŸã‚ã«å¿…é ˆ!) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================
        // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã¨çŠ¶æ…‹ (State)
        // =========================================================

        const VIEWS = {
            HOME: 'home',
            MY_APPS: 'my_apps',
            STORE: 'store',
            APP_DETAIL: 'app_detail',
        };
        
        let currentView = VIEWS.HOME;
        let activeAppId = null;
        
        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ (Firestoreã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ã‚ˆï¼)
        window.installedApps = {}; 
        let isDeletionMode = false; // ã‚´ãƒŸç®±ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°

        // Firebaseé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app = null;
        let db = null;
        let auth = null;
        let userId = 'loading'; // èªè¨¼ãŒå®Œäº†ã™ã‚‹ã¾ã§'loading'
        let isAuthReady = false; // èªè¨¼å®Œäº†ãƒ•ãƒ©ã‚°
        
        // Firebaseè¨­å®šã®ãƒ­ãƒ¼ãƒ‰
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // =========================================================
        // 2. FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        // =========================================================
        
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebaseã®è¨­å®šãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        if (user) {
                            userId = user.uid;
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            userId = auth.currentUser.uid;
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                        isAuthReady = true;
                        resolve();
                    }, reject);
                });

                setupInstalledAppsListener();

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
                isAuthReady = true; 
            }
        }

        // =========================================================
        // 3. Firestore (ã‚¢ãƒ—ãƒªã®æ°¸ç¶šåŒ–ãƒ­ã‚¸ãƒƒã‚¯)
        // =========================================================

        function getInstalledAppsCollectionPath() {
            return `artifacts/${appId}/users/${userId}/installedApps`;
        }
        
        function setupInstalledAppsListener() {
            if (!db || !isAuthReady) {
                return;
            }

            const appsColRef = collection(db, getInstalledAppsCollectionPath());
            
            onSnapshot(appsColRef, (snapshot) => {
                const newApps = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newApps[doc.id] = { ...data, id: doc.id };
                });

                window.installedApps = newApps;
                
                if (currentView === VIEWS.MY_APPS || currentView === VIEWS.STORE) {
                    showView(currentView);
                }
            }, (error) => {
                console.error("Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
            });
        }
        
        window.installApp = async function(appId) {
            if (!db || !isAuthReady) {
                showMessageBox('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“...ğŸ˜¢', 'bg-red-500');
                return;
            }

            // window.APPS_DATAã¯ app_loader.js ãŒæº–å‚™ã™ã‚‹
            const appData = window.APPS_DATA[appId]; 
            if (!appData) {
                showMessageBox('ãã®ã‚¢ãƒ—ãƒªã¯è¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆï¼', 'bg-red-500');
                return;
            }

            try {
                const appDocRef = doc(db, getInstalledAppsCollectionPath(), appId);
                await setDoc(appDocRef, {
                    name: appData.name,
                    icon: appData.icon,
                    installedAt: new Date().toISOString()
                });
                showMessageBox(`${appData.name} ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚ˆï¼ğŸ‰`, 'bg-green-500');
            } catch (error) {
                console.error("ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—:", error);
                showMessageBox('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸ...ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼', 'bg-red-500');
            }
        };

        window.uninstallApp = async function(appId) {
            if (!db || !isAuthReady) {
                showMessageBox('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“...ğŸ˜¢', 'bg-red-500');
                return;
            }
            
            const appData = window.APPS_DATA[appId];
            const appName = appData ? appData.name : 'ã“ã®ã‚¢ãƒ—ãƒª';

            showConfirmModal(`æœ¬å½“ã« ${appName} ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ï¼Ÿ`, 
                async () => {
                    try {
                        const appDocRef = doc(db, getInstalledAppsCollectionPath(), appId);
                        await deleteDoc(appDocRef);
                        showMessageBox(`${appName} ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚ˆï¼ğŸ‘‹`, 'bg-purple-500');
                        window.toggleDeletionMode();
                    } catch (error) {
                        console.error("ã‚¢ãƒ—ãƒªã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—:", error);
                        showMessageBox('ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸ...ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼', 'bg-red-500');
                    }
                },
                () => {}
            );
        };
        
        // =========================================================
        // 4. UI/ãƒ“ãƒ¥ãƒ¼ç®¡ç†
        // =========================================================
        
        window.showView = function(viewName, appId = null) {
            currentView = viewName;
            activeAppId = appId;
            const container = document.getElementById('app-container');

            let html = '';
            switch (viewName) {
                case VIEWS.HOME:
                    html = renderHome();
                    isDeletionMode = false;
                    break;
                case VIEWS.MY_APPS:
                    html = renderMyApps();
                    break;
                case VIEWS.STORE:
                    html = renderAppStore();
                    isDeletionMode = false;
                    break;
                case VIEWS.APP_DETAIL:
                    // ä¿®æ­£: window.APPS_DATA[appId].renderFunction ã‚’å‘¼ã³å‡ºã™
                    html = window.APPS_DATA[appId]?.renderFunction ? window.APPS_DATA[appId].renderFunction() : renderNotFound();
                    isDeletionMode = false;
                    break;
                default:
                    html = renderNotFound();
            }

            container.innerHTML = html;
            lucide.createIcons(); 
            // ä¿®æ­£: window.APPS_DATA[appId].onLaunch ã‚’å‘¼ã³å‡ºã™
            if (viewName === VIEWS.APP_DETAIL && window.APPS_DATA[appId]?.onLaunch) {
                 window.APPS_DATA[appId].onLaunch();
            }
        };

        // =========================================================
        // 5. UI: ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹
        // =========================================================
        
        window.showMessageBox = function(message, bgColorClass = 'bg-gray-700') {
            const container = document.getElementById('app-container');
            let messageBox = document.getElementById('custom-message-box');

            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'custom-message-box';
                messageBox.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-out opacity-0 translate-y-4';
                container.appendChild(messageBox);
            }

            messageBox.innerHTML = `
                <div class="px-5 py-3 rounded-xl text-white font-semibold shadow-2xl ${bgColorClass} flex items-center space-x-2">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            lucide.createIcons();

            setTimeout(() => {
                messageBox.classList.remove('opacity-0', 'translate-y-4');
                messageBox.classList.add('opacity-100', 'translate-y-0');
            }, 50);

            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        };

        window.showConfirmModal = function(message, onConfirm, onCancel) {
            const modalId = 'custom-confirm-modal';
            let modal = document.getElementById(modalId);
            const container = document.getElementById('app-container');

            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300';
            modal.style.opacity = '0'; 
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 max-w-[90%] transform transition-transform duration-300 scale-95">
                    <p class="text-lg font-semibold text-gray-800 mb-6 text-center">${message}</p>
                    <div class="flex justify-around space-x-4">
                        <button id="modal-cancel-btn" class="flex-1 py-2 px-4 bg-gray-300 text-gray-800 font-bold rounded-xl hover:bg-gray-400 transition">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button id="modal-confirm-btn" class="flex-1 py-2 px-4 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition">
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(modal);
            
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);

            const close = () => {
                modal.style.opacity = '0';
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => modal.remove(), 300);
            };

            document.getElementById('modal-confirm-btn').onclick = () => {
                onConfirm();
                close();
            };

            document.getElementById('modal-cancel-btn').onclick = () => {
                onCancel();
                close();
            };
        };

        // =========================================================
        // 6. UI: å„ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // =========================================================
        
        window.renderAppStore = function() {
            const allApps = window.APPS_DATA || {};
            const installedAppIds = Object.keys(window.installedApps);
            // ä¿®æ­£: Object.values(allApps) ã®ä»£ã‚ã‚Šã« Object.keys(allApps) ã‚’ä½¿ã£ã¦ã‚½ãƒ¼ãƒˆ
            const sortedAppIds = Object.keys(allApps).sort();

            const appCards = sortedAppIds.map(appId => {
                const app = allApps[appId];
                const isInstalled = installedAppIds.includes(app.id);
                
                const button = isInstalled ? 
                    `<button onclick="showView(VIEWS.APP_DETAIL, '${app.id}')"
                        class="mt-4 w-full py-2 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-150 transform active:scale-95">
                        èµ·å‹•ã™ã‚‹
                    </button>` :
                    `<button onclick="installApp('${app.id}')"
                        class="mt-4 w-full py-2 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 transform active:scale-95">
                        ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                    </button>`;

                return `
                    <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col justify-between transform hover:scale-[1.02] transition duration-200 border-2 ${isInstalled ? 'border-green-400' : 'border-gray-200'}">
                        <div class="flex items-center space-x-3 mb-3">
                            <span class="text-3xl">${app.icon}</span>
                            <h3 class="text-xl font-bold text-gray-800">${app.name}</h3>
                        </div>
                        <p class="text-sm text-gray-600 flex-grow">${app.description}</p>
                        ${button}
                    </div>
                `;
            }).join('');

            return `
                <div class="p-6 pt-10 min-h-screen bg-gray-100">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="showView(VIEWS.HOME)" class="text-gray-600 hover:text-gray-800 transition duration-150 transform active:scale-90">
                            <i data-lucide="chevron-left" class="w-8 h-8"></i>
                        </button>
                        <h1 class="text-3xl font-extrabold text-gray-800 flex-grow text-center pr-8">
                            ğŸ  ã¾ã£ã¡ã‚ƒã‚¹ãƒˆã‚¢
                        </h1>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${appCards}
                    </div>
                    
                </div>
            `;
        };
        
        window.renderMyApps = function() {
            const installedAppIds = Object.keys(window.installedApps);
            const installedAppList = installedAppIds
                .map(appId => window.APPS_DATA[appId])
                .filter(app => app);
            
            const appCards = installedAppList.map(app => {
                const clickAction = isDeletionMode 
                    ? `uninstallApp('${app.id}')` 
                    : `showView(VIEWS.APP_DETAIL, '${app.id}')`; 
                
                const deletionBadge = isDeletionMode ? `
                    <div class="absolute top-[-8px] right-[-8px] w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white border-2 border-white shadow-lg z-10 animate-pulse">
                        <i data-lucide="minus" class="w-4 h-4"></i>
                    </div>
                ` : '';

                return `
                    <div onclick="${clickAction}" 
                         class="relative bg-white p-4 rounded-xl shadow-lg flex flex-col items-center cursor-pointer 
                                transform transition duration-200 
                                ${isDeletionMode ? 'animate-pulse border-4 border-red-500' : 'hover:scale-[1.05] border-2 border-transparent hover:border-blue-300 active:scale-95'}">
                        ${deletionBadge}
                        <span class="text-5xl mb-2">${app.icon}</span>
                        <h3 class="text-lg font-semibold text-gray-800 text-center">${app.name}</h3>
                    </div>
                `;
            }).join('');
            
            const trashIcon = `
                <button onclick="toggleDeletionMode()" 
                    class="p-2 rounded-full transition duration-200 transform active:scale-90
                           ${isDeletionMode ? 'bg-red-500 text-white shadow-xl' : 'bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-500'}">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                </button>
            `;
            
            const emptyMessage = `
                <div class="p-10 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center text-gray-500 mt-8">
                    <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-4"></i>
                    <p class="text-xl font-bold">ã‚¢ãƒ—ãƒªãŒã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãªã„ã‚ˆï¼</p>
                    <p class="mt-2">ã€Œã¾ã£ã¡ã‚ƒã‚¹ãƒˆã‚¢ã€ã§æ°—ã«å…¥ã£ãŸã‚¢ãƒ—ãƒªã‚’è¦‹ã¤ã‘ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã‚ˆã†ï¼</p>
                    <button onclick="showView(VIEWS.STORE)" class="mt-4 py-2 px-4 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition transform active:scale-95">
                        ã‚¹ãƒˆã‚¢ã¸è¡Œã
                    </button>
                </div>
            `;
            
            return `
                <div class="p-6 pt-10 min-h-screen bg-blue-50">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="showView(VIEWS.HOME)" class="text-blue-600 hover:text-blue-800 transition duration-150 transform active:scale-90">
                            <i data-lucide="chevron-left" class="w-8 h-8"></i>
                        </button>
                        <div class="flex items-center flex-grow justify-center -ml-8">
                            <h1 class="text-3xl font-extrabold text-gray-800 mr-4">
                                ğŸ“± ãƒã‚¤ã‚¢ãƒ—ãƒª
                            </h1>
                            ${trashIcon}
                        </div>
                    </div>
                    
                    ${installedAppList.length === 0 ? emptyMessage : `
                        <p class="text-center text-red-600 font-bold mb-6 transition duration-300 h-6">
                            ${isDeletionMode ? 'ğŸš¨ å‰Šé™¤ã—ãŸã„ã‚¢ãƒ—ãƒªã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼' : 'ã‚¿ãƒƒãƒ—ã§èµ·å‹•ã™ã‚‹ã‚ˆï¼'}
                        </p>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-6">
                            ${appCards}
                        </div>
                    `}
                    
                </div>
            `;
        };
        
        window.toggleDeletionMode = function() {
            isDeletionMode = !isDeletionMode;
            showView(VIEWS.MY_APPS);
            
            if (isDeletionMode) {
                showMessageBox('ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ONï¼ã‚¢ãƒ—ãƒªã‚’ã‚¿ãƒƒãƒ—ã§ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆï¼', 'bg-red-500');
            } else {
                showMessageBox('âœ… å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰OFFã€‚', 'bg-green-500');
            }
        };

        function renderHome() {
            const installedAppIds = Object.keys(window.installedApps);
            const recentAppList = installedAppIds
                .map(appId => window.APPS_DATA[appId])
                .filter(app => app)
                .slice(0, 8); 

            const appIcons = recentAppList.map(app => `
                <div onclick="showView(VIEWS.APP_DETAIL, '${app.id}')" 
                     class="flex flex-col items-center space-y-1 cursor-pointer transform hover:scale-[1.1] transition duration-200 active:scale-95">
                    <div class="bg-white p-3 rounded-2xl shadow-lg border border-gray-100">
                        <span class="text-4xl">${app.icon}</span>
                    </div>
                    <span class="text-xs text-gray-700 font-medium whitespace-nowrap">${app.name.split(' ')[0]}</span>
                </div>
            `).join('');

            return `
                <div class="p-6 pt-10 min-h-screen bg-yellow-50">
                    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="text-center mb-10">
                        <span class="text-5xl">ğŸ¢</span>
                        <h1 class="text-4xl font-extrabold text-green-700 mt-2">ã¾ã£ã¡ã‚ƒ OS</h1>
                        <p class="text-gray-600 mt-1">AIæ‹¡å¼µæ©Ÿèƒ½ã§ã€ã‚‚ã£ã¨ä¾¿åˆ©ã«ï¼</p>
                        <p class="text-xs text-gray-400 mt-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}</p>
                    </div>

                    <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                    <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto">
                        <div onclick="showView(VIEWS.MY_APPS)" 
                             class="flex flex-col items-center p-6 bg-white rounded-3xl shadow-xl border-b-4 border-blue-500 cursor-pointer transform hover:scale-[1.05] transition duration-200 active:scale-95">
                            <i data-lucide="layout-grid" class="w-8 h-8 text-blue-500 mb-2"></i>
                            <span class="text-lg font-bold text-gray-800">ãƒã‚¤ã‚¢ãƒ—ãƒª</span>
                            <span class="text-sm text-gray-500">${installedAppIds.length}å€‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿</span>
                        </div>
                        <div onclick="showView(VIEWS.STORE)" 
                             class="flex flex-col items-center p-6 bg-white rounded-3xl shadow-xl border-b-4 border-green-500 cursor-pointer transform hover:scale-[1.05] transition duration-200 active:scale-95">
                            <i data-lucide="store" class="w-8 h-8 text-green-500 mb-2"></i>
                            <span class="text-lg font-bold text-gray-800">ã¾ã£ã¡ã‚ƒã‚¹ãƒˆã‚¢</span>
                            <span class="text-sm text-gray-500">${Object.keys(window.APPS_DATA || {}).length}ç¨®é¡ã®ã‚¢ãƒ—ãƒª</span>
                        </div>
                    </div>

                    <!-- æœ€è¿‘ä½¿ã£ãŸã‚¢ãƒ—ãƒª -->
                    <div class="mt-12">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-center">
                            <i data-lucide="star" class="w-5 h-5 text-yellow-500 mr-2"></i>
                            ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã‚¢ãƒ—ãƒª
                        </h2>
                        ${recentAppList.length > 0 ? `
                            <div class="grid grid-cols-4 gap-4 justify-items-center max-w-lg mx-auto">
                                ${appIcons}
                            </div>
                        ` : `
                            <p class="text-center text-gray-500 mt-4">ã¾ã ã‚¢ãƒ—ãƒªã‚’ä½¿ã£ã¦ãªã„ã­ï¼ã‚¹ãƒˆã‚¢ã¸GOï¼</p>
                        `}
                    </div>
                </div>
            `;
        }

        function renderNotFound() {
            return `
                <div class="p-6 pt-10 min-h-screen bg-red-50 text-center flex flex-col justify-center items-center">
                    <i data-lucide="bug-off" class="w-16 h-16 text-red-500 mb-4"></i>
                    <h1 class="text-3xl font-bold text-red-700 mb-2">ã‚¨ãƒ©ãƒ¼ï¼šã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1>
                    <p class="text-gray-600 mb-6">æŒ‡å®šã•ã‚ŒãŸã‚¢ãƒ—ãƒªIDã¯å­˜åœ¨ã—ãªã„ã¿ãŸã„...ğŸ˜¢</p>
                    <button onclick="showView(VIEWS.MY_APPS)" class="py-2 px-4 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition transform active:scale-95">
                        ãƒã‚¤ã‚¢ãƒ—ãƒªã¸æˆ»ã‚‹
                    </button>
                </div>
            `;
        }
        
        // =========================================================
        // 7. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // =========================================================

        /**
         * æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãã®ãƒ•ã‚§ãƒƒãƒé–¢æ•° (Gemini APIã®å‘¼ã³å‡ºã—ã«ä½¿ç”¨)
         */
        window._callFetch = async function(url, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error with status: ${response.status}`);
                    }
                    
                    return response; // æˆåŠŸ
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        /**
         * ç°¡æ˜“çš„ãªMarkdown to HTMLå¤‰æ›é–¢æ•°
         */
        window.markdownToHtml = function(markdown) {
            let html = markdown
                .replace(/### (.*)/g, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>') 
                .replace(/## (.*)/g, '<h2 class="text-xl font-bold mt-5 mb-3">$1</h2>') 
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>') 
                .replace(/\* (.*)/g, '<li class="ml-4 list-disc text-sm">$1</li>'); 
            
            if (html.includes('<li')) {
                html = `<ul>${html}</ul>`;
                html = html.replace(/<\/h3><ul>/g, '</h3><ul class="ml-2">');
                html = html.replace(/<\/h2><ul>/g, '</h2><ul class="ml-2">');
            }

            html = html.split('\n\n').map(p => {
                if (p.trim() === '' || p.startsWith('<h') || p.startsWith('<ul>') || p.startsWith('<li') || p.startsWith('<hr')) {
                    return p;
                }
                return `<p class="mb-3">${p}</p>`;
            }).join('');
            
            html = html.replace(/---/g, '<hr class="my-4 border-gray-300">');
            html = html.replace(/\n/g, '<br>');

            return html;
        };

        // =========================================================
        // 8. åˆæœŸãƒ­ãƒ¼ãƒ‰
        // =========================================================

        window.VIEWS = VIEWS; 
        window.isDeletionMode = isDeletionMode; 
        window.toggleDeletionMode = window.toggleDeletionMode; 

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // ã‚¢ãƒ—ãƒªãƒ­ãƒ¼ãƒ€ãƒ¼ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤ãŸã‚ã®Promiseã‚’ä½œæˆ
            const appLoaderPromise = new Promise(resolve => {
                window.resolveAppLoader = resolve;
            });

            // Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼ã‚’å¾…ã¤
            await initializeFirebase(); 
            
            // ã‚¢ãƒ—ãƒªã®ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
            await appLoaderPromise;

            // èªè¨¼ã¨ã‚¢ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
            showView(VIEWS.HOME);
        });

    </script>
    
    <!-- Lucide Iconsã®CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- å¤–éƒ¨ã‚¢ãƒ—ãƒªãƒ­ãƒ¼ãƒ€ãƒ¼ (apps.jsã®ä»£ã‚ã‚Šã«ã“ã‚Œã‚’èª­ã¿è¾¼ã‚€ã‚ˆï¼) -->
    <!-- app_loader.jsãŒ apps/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚¢ãƒ—ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ãã‚Œã‚‹ -->
    <script src="app_loader.js"></script> 
</body>
</html>
