<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🍵 まっちゃアプリ</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Iconsを読み込み (アイコン用) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* カスタムスタイル */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        #app-container {
            width: 100%;
            max-width: 420px; /* スマホサイズに制限 */
            min-height: 100vh;
            display: flex; /* Flexboxでコンテンツとナビゲーションを配置 */
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: white;
            position: relative; /* 子要素の配置基準 */
        }
        .app-icon-item {
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .app-icon-item:active {
            transform: scale(0.95);
        }
        .content-area {
            flex-grow: 1; /* コンテンツエリアが残りの高さを占める */
            overflow-y: auto; /* コンテンツがはみ出たらスクロール */
            padding-bottom: 72px; /* ナビゲーションバーの高さ分 */
        }
    </style>
</head>
<body onload="initApp();">

<div id="app-container">
    <!-- メインコンテンツはここにレンダリングされる -->
    <div id="main-content" class="content-area"></div>

    <!-- ナビゲーションバー (常に画面下部に固定) -->
    <nav class="fixed bottom-0 w-full max-w-[420px] bg-white border-t border-gray-200 shadow-xl flex justify-around items-center h-16 z-10">
        <!-- ナビゲーションアイテム -->
        <button id="nav-home" class="nav-item text-center flex flex-col items-center p-2 text-green-600" onclick="showView(VIEWS.HOME)">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-xs font-semibold mt-0.5">ホーム</span>
        </button>
        <button id="nav-store" class="nav-item text-center flex flex-col items-center p-2 text-gray-500" onclick="showView(VIEWS.STORE)">
            <i data-lucide="shopping-bag" class="w-6 h-6"></i>
            <span class="text-xs font-semibold mt-0.5">ショップ</span>
        </button>
        <button id="nav-apps" class="nav-item text-center flex flex-col items-center p-2 text-gray-500" onclick="showView(VIEWS.MY_APPS)">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
            <span class="text-xs font-semibold mt-0.5">マイアプリ</span>
        </button>
    </nav>
</div>

<script src="apps.js"></script> <!-- 拡張機能データを読み込む -->
<script>
    // =========================================================
    // 🍵 まっちゃアプリ
    // =========================================================

    // ビューの状態
    const VIEWS = {
        HOME: 'home',
        STORE: 'store',
        MY_APPS: 'my_apps'
    };
    let currentView = VIEWS.HOME;
    
    // アプリの状態
    // このオブジェクトは apps.js で定義された APPS_DATA を参照する
    let installedAppsState = {};

    // API情報（apps.jsに渡すためにグローバル化）
    const API_KEY = "";
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
    window.GEMINI_API_URL = API_URL;
    window.GEMINI_API_KEY = API_KEY;
    
    const MAIN_CONTENT = document.getElementById('main-content');

    // アプリ初期化
    function initApp() {
        // Firebase初期化をシミュレート（将来の認証・DB用）
        window.firebaseSetup = async () => {
            console.log("Firebase setup skipped.");
        };
        firebaseSetup();
        
        // APPS_DATAをコピーし、インストール状態を初期化 (初回のみ)
        if (typeof APPS_DATA === 'undefined') {
            console.error("apps.jsがロードされていません！");
            return;
        }
        
        Object.keys(APPS_DATA).forEach(id => {
            installedAppsState[id] = { ...APPS_DATA[id], installed: false };
        });

        // 献立プランナーをデフォルトでインストール済みにする (デバッグ用)
        // installedAppsState['meal_planner'].installed = true;
        
        renderApp();
    }
    
    // =========================================================
    // 画面切り替えとレンダリング
    // =========================================================

    function showView(view) {
        currentView = view;
        renderApp();
    }

    function renderApp() {
        let contentHTML = '';
        switch (currentView) {
            case VIEWS.HOME:
                contentHTML = renderHomeScreen();
                break;
            case VIEWS.STORE:
                contentHTML = renderStoreScreen();
                break;
            case VIEWS.MY_APPS:
                contentHTML = renderMyAppsScreen();
                break;
        }
        MAIN_CONTENT.innerHTML = contentHTML;
        lucide.createIcons(); // アイコンをレンダリング
        updateNavBar();
    }
    
    function updateNavBar() {
        ['home', 'store', 'apps'].forEach(id => {
            const btn = document.getElementById(`nav-${id}`);
            if (btn) {
                // ナビゲーションボタンの色を更新
                const isCurrent = (id === 'home' && currentView === VIEWS.HOME) ||
                                  (id === 'store' && currentView === VIEWS.STORE) ||
                                  (id === 'apps' && currentView === VIEWS.MY_APPS);

                btn.classList.toggle('text-green-600', isCurrent);
                btn.classList.toggle('text-gray-500', !isCurrent);
                btn.classList.toggle('font-bold', isCurrent);
            }
        });
    }


    // 1. ホーム画面 (アプリ起動画面として機能させる)
    function renderHomeScreen() {
        return `
            <div class="p-6 pt-10 min-h-full bg-green-50">
                <h1 class="text-3xl font-extrabold text-green-800 mb-8 border-b-2 pb-2 border-green-300">🍵 まっちゃアプリ OS</h1>
                
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-yellow-500 fill-yellow-100"></i>
                        主要機能
                    </h2>
                    <p class="text-gray-600 mb-6">「まっちゃアプリ」のメイン機能です。</p>

                    <div class="grid grid-cols-2 gap-4">
                        ${renderCoreAppIcon('ストア', '🛒', () => showView(VIEWS.STORE), 'bg-green-100 text-green-700')}
                        ${renderCoreAppIcon('マイアプリ', '🗂️', () => showView(VIEWS.MY_APPS), 'bg-blue-100 text-blue-700')}
                    </div>
                </div>

                <div class="mt-8 p-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg">
                    <p class="font-semibold">💡 Tips: アプリは「マイアプリ」から起動できます。</p>
                    <p class="text-sm mt-1">下のナビゲーションバーの「マイアプリ」をタップするか、ストアからインストールしましょう！</p>
                </div>
            </div>
        `;
    }

    // 2. ストア画面 (インストール処理)
    function renderStoreScreen() {
        const appCards = Object.entries(installedAppsState).map(([id, app]) => `
            <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between transition duration-300 hover:bg-gray-50">
                <div class="flex items-center">
                    <div class="text-4xl mr-4">${app.icon}</div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${app.name}</h3>
                        <p class="text-sm text-gray-500">${app.description}</p>
                    </div>
                </div>
                ${app.installed 
                    ? `<span class="px-3 py-1 text-xs font-semibold text-green-700 bg-green-200 rounded-full flex-shrink-0">インストール済み</span>`
                    : `<button class="bg-green-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-600 active:bg-green-700 shadow-md transition duration-150 flex-shrink-0"
                              onclick="installApp('${id}')">
                            インストール
                        </button>`
                }
            </div>
        `).join('<div class="h-4"></div>');

        return `
            <div class="p-6 pt-10 min-h-full bg-gray-100">
                <h1 class="text-3xl font-extrabold text-green-800 mb-6">🛒 まっちゃストア</h1>
                <p class="text-gray-600 mb-8">AI拡張機能をダウンロードしよう！</p>
                ${appCards}
                <div class="h-10"></div>
            </div>
        `;
    }

    // 3. マイアプリ画面 (インストール済みアプリの起動)
    function renderMyAppsScreen() {
        const installedApps = Object.entries(installedAppsState)
            .filter(([id, app]) => app.installed);
            
        const appIcons = installedApps.map(([id, app]) => `
            <div class="app-icon-item text-center p-4 bg-white rounded-xl shadow-lg cursor-pointer hover:bg-gray-50" 
                 onclick="launchApp('${id}')">
                <div class="text-4xl">${app.icon}</div>
                <p class="text-xs font-semibold mt-1 text-gray-700">${app.name}</p>
            </div>
        `).join('');

        return `
            <div class="p-6 pt-10 min-h-full bg-gray-100">
                <h1 class="text-3xl font-extrabold text-green-800 mb-6">🗂️ マイアプリ</h1>
                <p class="text-gray-600 mb-8">${installedApps.length}個のアプリがインストールされています。</p>

                <div class="grid grid-cols-3 gap-6">
                    ${appIcons}
                </div>
                
                ${installedApps.length === 0 ? 
                    `<div class="mt-10 p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg text-center">
                        <p class="font-bold text-xl">アプリがありません</p>
                        <p class="text-sm mt-2">下の「ショップ」タブからアプリをインストールしましょう！</p>
                    </div>` : ''}
                <div class="h-10"></div>
            </div>
        `;
    }

    // =========================================================
    // アプリケーションロジック（起動・インストール）
    // =========================================================

    function installApp(id) {
        if (installedAppsState[id]) {
            installedAppsState[id].installed = true;
            // メッセージボックスで完了を通知
            showMessageBox(`✅ ${installedAppsState[id].name} のインストールが完了！`, 'bg-green-500');
            // ストア画面を再レンダリング
            renderApp();
        }
    }

    function launchApp(id) {
        const app = installedAppsState[id];
        if (app && app.installed && app.renderFunction) {
            // アプリ起動（アプリのレンダリング関数を呼び出し、コンテンツエリアを置き換える）
            MAIN_CONTENT.innerHTML = app.renderFunction();
            // 献立プランナー特有の初期化が必要な場合はここで呼び出す
            if (app.id === 'meal_planner' && typeof setupMealPlanner === 'function') {
                setupMealPlanner();
            }
            // アプリ起動中はナビゲーションバーを一時的に非表示または非アクティブにすることもできるが、
            // 今回はOS感を出すためにそのままにして、アプリ内で戻るボタンを持たせる。
            lucide.createIcons();
            showMessageBox(`${app.name} を起動しました！`, 'bg-blue-500');
        } else {
            showMessageBox(`${app.name} はまだインストールされていません、または壊れています！`, 'bg-red-500');
        }
    }
    
    // アプリのアイコン描画ヘルパー
    function renderCoreAppIcon(name, icon, onClick, bgColor) {
        return `
            <div class="app-icon-item text-center p-4 ${bgColor} rounded-xl shadow-md cursor-pointer hover:shadow-lg" 
                 onclick="${onClick.toString().replace('() =>', '').replace('{', '').replace('}', '').trim()}">
                <div class="text-4xl">${icon}</div>
                <p class="text-xs font-semibold mt-1">${name}</p>
            </div>
        `;
    }

    // =========================================================
    // UIユーティリティ
    // =========================================================

    // カスタムメッセージボックス (alert()の代わり)
    function showMessageBox(message, bgColor) {
        let msgBox = document.getElementById('custom-message-box');
        if (!msgBox) {
            msgBox = document.createElement('div');
            msgBox.id = 'custom-message-box';
            msgBox.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 opacity-0 min-w-80 max-w-full text-center';
            document.body.appendChild(msgBox);
        }
        
        if (window.msgTimer) clearTimeout(window.msgTimer);

        msgBox.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 opacity-100 ${bgColor}`;
        msgBox.textContent = message;

        window.msgTimer = setTimeout(() => {
            msgBox.classList.remove('opacity-100');
            msgBox.classList.add('opacity-0');
        }, 3000);
    }
    
    // ダミーのfetchラッパー（apps.jsからも呼び出せるようにグローバル化）
    window._callFetch = async function(url, payload) {
        // ロード感を出すために2秒待機
        await new Promise(resolve => setTimeout(resolve, 2000));

        // ダミー応答を返す
        const resultText = `
        🎉 ${payload.contents[0].parts[0].text.includes('献立') ? '献立' : 'おしゃべり'}リクエストを処理したぞ！

        ---
        
        ### 献立提案1: 豚肉の生姜焼き定食
        * **概要:** 豚肉と玉ねぎを使って定番の生姜焼きを。白ご飯が進む最強メニューだ！
        * **追加食材:** 玉ねぎ、醤油、みりん、酒、生姜

        ### 献立提案2: 冷蔵庫の残り物カレー
        * **概要:** 残り物の野菜（あれば）と豚肉で、次の日の朝も楽しめるカレーにするぜ！
        * **追加食材:** カレールー、人参、じゃがいも、玉ねぎ（もしなかったら）
        
        ### 献立提案3: 豚バラとキャベツのレンジ蒸し
        * **概要:** 豚バラとキャベツを重ねて、レンジでチンするだけ。ポン酢でさっぱり食べられる！
        * **追加食材:** キャベツ、ポン酢
        
        `;
        
        return {
            status: 200,
            json: async () => ({
                candidates: [{
                    content: {
                        parts: [{
                            text: resultText
                        }]
                    }
                }]
            })
        };
    };

</script>

</body>
</html>
